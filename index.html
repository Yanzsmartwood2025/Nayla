<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NAYLA AI | PRO CONSOLE</title>
    
    <!-- PWA Setup -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" id="manifest-placeholder">

    <!-- Librerías -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Generador de Manifiesto -->
    <script>
        const manifest = {
            "name": "Nayla AI",
            "short_name": "Nayla",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#000000",
            "theme_color": "#000000",
            "icons": [{"src": "https://img.icons8.com/fluency/192/artificial-intelligence.png", "sizes": "192x192", "type": "image/png"}]
        };
        document.querySelector('#manifest-placeholder').setAttribute('href', URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'})));
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap');
        body { background-color: #000; color: #fff; font-family: 'Space Grotesk', sans-serif; overflow: hidden; }
        
        .glass-panel { background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .bar { width: 5px; background: #ec4899; border-radius: 4px; animation: equalize 0.8s infinite ease-in-out; }
        .bar:nth-child(2) { animation-delay: 0.1s; } .bar:nth-child(3) { animation-delay: 0.2s; }
        @keyframes equalize { 0%, 100% { height: 30%; } 50% { height: 100%; } }
        
        /* Animación suave */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- PANTALLA DE LOGIN (Estilo SaaS) ---
        function LoginScreen({ onLogin }) {
            const [provider, setProvider] = useState("gemini"); // 'gemini' o 'grok'
            const [key, setKey] = useState("");

            return (
                <div className="flex flex-col h-screen items-center justify-center p-6 bg-black relative">
                    <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-purple-900/20 via-black to-black"></div>
                    
                    <div className="z-10 w-full max-w-sm text-center fade-in">
                        <div className="w-20 h-20 bg-gradient-to-tr from-pink-500 to-purple-600 rounded-2xl mx-auto mb-6 flex items-center justify-center shadow-[0_0_40px_rgba(236,72,153,0.4)]">
                            <i className="fas fa-microchip text-4xl text-white"></i>
                        </div>
                        <h1 className="text-3xl font-bold tracking-tight mb-1">NAYLA <span className="text-pink-500">VOICE</span></h1>
                        <p className="text-gray-500 text-xs mb-8 uppercase tracking-widest">Sistema de Inteligencia Artificial v5.0</p>

                        <div className="glass-panel p-6 rounded-2xl text-left">
                            <label className="text-[10px] text-gray-400 font-bold block mb-2">SELECCIONA CEREBRO IA</label>
                            <div className="grid grid-cols-2 gap-2 mb-4">
                                <button 
                                    onClick={() => setProvider('gemini')}
                                    className={`p-3 rounded-lg text-xs font-bold border transition ${provider === 'gemini' ? 'bg-blue-600/20 border-blue-500 text-blue-400' : 'bg-black border-gray-800 text-gray-500'}`}
                                >
                                    <i className="fab fa-google mr-2"></i> GEMINI
                                </button>
                                <button 
                                    onClick={() => setProvider('grok')}
                                    className={`p-3 rounded-lg text-xs font-bold border transition ${provider === 'grok' ? 'bg-white/10 border-white text-white' : 'bg-black border-gray-800 text-gray-500'}`}
                                >
                                    <i className="fas fa-robot mr-2"></i> GROK (xAI)
                                </button>
                            </div>

                            <label className="text-[10px] text-gray-400 font-bold block mb-2">LICENCIA (API KEY)</label>
                            <input 
                                type="password" 
                                value={key}
                                onChange={(e) => setKey(e.target.value)}
                                placeholder={provider === 'grok' ? "xai-..." : "AIza..."}
                                className="w-full bg-black/50 border border-gray-700 rounded-xl p-3 text-white text-xs outline-none focus:border-pink-500 transition mb-4 font-mono"
                            />
                            
                            <button 
                                onClick={() => onLogin(provider, key)}
                                disabled={!key}
                                className="w-full bg-white text-black font-bold py-3 rounded-xl hover:scale-[1.02] active:scale-95 transition disabled:opacity-50"
                            >
                                CONECTAR SISTEMA
                            </button>
                        </div>
                        <p className="text-[9px] text-gray-700 mt-6">Optimizado para TikTok Live Audio • 2025</p>
                    </div>
                </div>
            );
        }

        // --- DASHBOARD PRINCIPAL ---
        function Dashboard({ config, onLogout }) {
            const [status, setStatus] = useState("ESPERA");
            const [transcript, setTranscript] = useState("");
            const [lastReply, setLastReply] = useState("");
            const [isMicOn, setIsMicOn] = useState(false);
            const [botName, setBotName] = useState("Nayla");

            const recognitionRef = useRef(null);

            // 1. SISTEMA DE AUDIO (OÍDOS)
            useEffect(() => {
                if (!('webkitSpeechRecognition' in window)) return;
                const recognition = new window.webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.lang = 'es-ES';

                recognition.onstart = () => setStatus("ESCUCHANDO");
                recognition.onend = () => { if (isMicOn && status !== 'HABLANDO') recognition.start(); };
                
                recognition.onresult = (event) => {
                    if (status === 'HABLANDO') return; 
                    const text = event.results[event.results.length - 1][0].transcript.trim();
                    setTranscript(text);
                    handleVoiceCommand(text);
                };

                recognitionRef.current = recognition;
            }, [isMicOn, status]);

            const toggleMic = () => {
                if (isMicOn) {
                    setIsMicOn(false);
                    recognitionRef.current?.stop();
                    setStatus("ESPERA");
                } else {
                    setIsMicOn(true);
                    recognitionRef.current?.start();
                    setStatus("ESCUCHANDO");
                }
            };

            // 2. CEREBRO (LLAMADA A API)
            const handleVoiceCommand = async (text) => {
                const lower = text.toLowerCase();
                const trigger = botName.toLowerCase();

                if (lower.includes(trigger)) {
                    recognitionRef.current?.stop();
                    setStatus("PENSANDO");
                    
                    const cleanText = text.replace(new RegExp(trigger, "gi"), "").trim();
                    const systemPrompt = `Eres ${botName}, asistente de TikTok Live. Personalidad: Coqueta, divertida, sarcástica. Responde en JSON: {"reply": "texto para leer"}. Máximo 20 palabras.`;
                    
                    try {
                        let replyText = "";
                        
                        if (config.provider === 'gemini') {
                            // CONEXIÓN GEMINI
                            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${config.key}`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    contents: [{ parts: [{ text: `${systemPrompt}\nUser: ${cleanText}` }] }],
                                    generationConfig: { responseMimeType: "application/json" }
                                })
                            });
                            const data = await res.json();
                            const json = JSON.parse(data.candidates[0].content.parts[0].text);
                            replyText = json.reply;

                        } else if (config.provider === 'grok') {
                            // CONEXIÓN GROK (xAI) - Simulada endpoint compatible OpenAI
                            const res = await fetch("https://api.x.ai/v1/chat/completions", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "Authorization": `Bearer ${config.key}`
                                },
                                body: JSON.stringify({
                                    messages: [
                                        { role: "system", content: systemPrompt },
                                        { role: "user", content: cleanText }
                                    ],
                                    model: "grok-beta", // O el modelo actual disponible
                                    stream: false
                                })
                            });
                            const data = await res.json();
                            // Grok a veces no devuelve JSON puro si no se fuerza, intentamos parsear
                            try {
                                const json = JSON.parse(data.choices[0].message.content);
                                replyText = json.reply;
                            } catch {
                                replyText = data.choices[0].message.content; // Fallback texto plano
                            }
                        }

                        setLastReply(replyText);
                        speak(replyText);

                    } catch (e) {
                        console.error(e);
                        speak("Error de conexión con el cerebro.");
                        setStatus("ESCUCHANDO");
                    }
                }
            };

            // 3. BOCA (TTS NATIVO)
            const speak = (text) => {
                setStatus("HABLANDO");
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'es-MX';
                u.rate = 1.1; // Ritmo TikTok
                u.pitch = 1.1; // Tono Femenino
                
                u.onend = () => {
                    setStatus("ESCUCHANDO");
                    if (isMicOn) recognitionRef.current?.start();
                };
                window.speechSynthesis.speak(u);
            };

            return (
                <div className="flex flex-col h-screen bg-black text-white fade-in">
                    {/* Top Bar */}
                    <div className="flex justify-between items-center p-4 z-20">
                        <div className="flex items-center gap-2 bg-white/10 px-3 py-1 rounded-full border border-white/10">
                            <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                            <span className="text-[10px] font-bold uppercase">{config.provider.toUpperCase()} ENGINE</span>
                        </div>
                        <button onClick={onLogout} className="w-8 h-8 flex items-center justify-center bg-gray-900 rounded-full text-gray-500"><i className="fas fa-power-off"></i></button>
                    </div>

                    {/* Main Interface */}
                    <div className="flex-1 flex flex-col items-center justify-center p-6 relative">
                        
                        {/* Indicador de Voz (Visualizer) */}
                        <div className="h-20 flex items-center justify-center gap-1.5 mb-8">
                            {status === 'HABLANDO' ? (
                                <>
                                    <div className="bar" style={{height: '40px', animationDelay: '0s'}}></div>
                                    <div className="bar" style={{height: '60px', animationDelay: '0.1s'}}></div>
                                    <div className="bar" style={{height: '80px', animationDelay: '0.2s'}}></div>
                                    <div className="bar" style={{height: '50px', animationDelay: '0.1s'}}></div>
                                </>
                            ) : (
                                <span className={`text-sm font-bold tracking-[0.3em] ${status === 'ESCUCHANDO' ? 'text-pink-500 animate-pulse' : 'text-gray-600'}`}>
                                    {status}
                                </span>
                            )}
                        </div>

                        {/* Botón Central */}
                        <div className="relative">
                            <div className={`absolute inset-0 bg-pink-500 blur-3xl opacity-20 rounded-full transition-opacity duration-500 ${isMicOn ? 'opacity-40' : 'opacity-0'}`}></div>
                            <button 
                                onClick={toggleMic}
                                className={`relative w-48 h-48 rounded-full border border-white/10 flex flex-col items-center justify-center transition-all duration-300 ${isMicOn ? 'bg-gradient-to-br from-gray-900 to-black scale-105 shadow-[0_0_50px_rgba(236,72,153,0.2)]' : 'bg-black hover:bg-gray-900'}`}
                            >
                                <i className={`fas text-5xl mb-4 transition-colors ${
                                    isMicOn 
                                        ? (status === 'PENSANDO' ? 'fa-bolt text-yellow-400 animate-bounce' : 'fa-microphone text-pink-500') 
                                        : 'fa-microphone-slash text-gray-700'
                                }`}></i>
                                <span className="text-[10px] text-gray-500 font-bold uppercase tracking-widest">
                                    {isMicOn ? 'LIVE' : 'OFFLINE'}
                                </span>
                            </button>
                        </div>

                        {/* Input Nombre */}
                        <div className="mt-12 w-full max-w-xs">
                            <label className="text-[9px] text-gray-600 font-bold block mb-2 text-center uppercase tracking-widest">Nombre de Activación</label>
                            <input 
                                value={botName}
                                onChange={(e) => setBotName(e.target.value)}
                                className="w-full bg-transparent border-b border-gray-800 text-center text-xl font-bold py-2 focus:border-pink-500 outline-none transition uppercase text-gray-300 placeholder-gray-700"
                                placeholder="NOMBRE"
                            />
                        </div>

                        {/* Ultima Respuesta */}
                        {lastReply && (
                            <div className="mt-6 p-4 glass-panel rounded-xl max-w-sm w-full">
                                <p className="text-xs text-gray-400 italic text-center">"{lastReply}"</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- APP ROOT ---
        function App() {
            const [config, setConfig] = useState(JSON.parse(localStorage.getItem('nayla_config')) || null);

            const handleLogin = (provider, key) => {
                const newConfig = { provider, key };
                setConfig(newConfig);
                localStorage.setItem('nayla_config', JSON.stringify(newConfig));
            };

            const handleLogout = () => {
                setConfig(null);
                localStorage.removeItem('nayla_config');
            };

            return config ? <Dashboard config={config} onLogout={handleLogout} /> : <LoginScreen onLogin={handleLogin} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
  </html>
